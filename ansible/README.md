# Ansible SSL Certificates and Nginx Configuration

Este projeto Ansible foi estruturado para instalar e configurar certificados SSL automaticamente usando Certbot e configurar o Nginx de forma dinÃ¢mica.

## Estrutura

```
ansible/
â”œâ”€â”€ group_vars/
â”‚   â””â”€â”€ all.yml                 # VariÃ¡veis globais do domÃ­nio
â”œâ”€â”€ roles/
â”‚   â”œâ”€â”€ ssl-certificates/       # Role para gestÃ£o de certificados SSL
â”‚   â”‚   â”œâ”€â”€ defaults/main.yml
â”‚   â”‚   â”œâ”€â”€ tasks/main.yml
â”‚   â”‚   â”œâ”€â”€ handlers/main.yml
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ ssl-params.conf.j2
â”‚   â”œâ”€â”€ nginx/                  # Role para configuraÃ§Ã£o do Nginx
â”‚   â”‚   â”œâ”€â”€ tasks/main.yml
â”‚   â”‚   â”œâ”€â”€ handlers/main.yml
â”‚   â”‚   â””â”€â”€ templates/
â”‚   â”‚       â””â”€â”€ site.conf.j2
â”‚   â””â”€â”€ systemd/                # Role para serviÃ§os systemd
â””â”€â”€ main.yml                    # Playbook principal
```

## ConfiguraÃ§Ã£o

### VariÃ¡veis Principais (group_vars/all.yml)

```yaml
# DomÃ­nio principal
domain_name: "paxa.dev"
domain_subdomains:
  - "www"
  - "pages"

# ConfiguraÃ§Ã£o do certificado SSL
ssl_certificate_email: "admin@paxa.dev"
ssl_certificate_staging: false  # true para testes
ssl_certificate_force_renewal: false

# ConfiguraÃ§Ã£o da aplicaÃ§Ã£o
app_port: 3033
github_pages_host: "sistematico.github.io"
github_pages_path: "/startpages"
```

## Como usar

### 1. Configurar o domÃ­nio
Edite o arquivo `group_vars/all.yml` e altere as variÃ¡veis conforme sua necessidade:

```yaml
domain_name: "seu-dominio.com"
domain_subdomains:
  - "www"
  - "blog"
  - "api"
ssl_certificate_email: "admin@seu-dominio.com"
```

### 2. Executar o playbook
```bash
ansible-playbook -i inventory main.yml
```

### 3. Para diferentes ambientes
VocÃª pode criar arquivos especÃ­ficos:
- `group_vars/production.yml`
- `group_vars/staging.yml`
- `host_vars/servidor1.yml`

## Funcionalidades

### Role ssl-certificates
- âœ… Instala Certbot via package manager (apt/yum/dnf)
- âœ… Gera certificados SSL automaticamente
- âœ… Configura renovaÃ§Ã£o automÃ¡tica
- âœ… Suporte a staging para testes
- âœ… Configura parÃ¢metros SSL seguros no Nginx
- âœ… Suporte a mÃºltiplas distribuiÃ§Ãµes Linux

### Role nginx (atualizada)
- âœ… ConfiguraÃ§Ã£o dinÃ¢mica baseada em variÃ¡veis
- âœ… Templates Jinja2 para configuraÃ§Ã£o flexÃ­vel
- âœ… Suporte a mÃºltiplos subdomÃ­nios
- âœ… Redirecionamento HTTP â†’ HTTPS automÃ¡tico
- âœ… Redirecionamento www â†’ nÃ£o-www

### Recursos de SeguranÃ§a
- ðŸ”’ TLS 1.2 e 1.3 apenas
- ðŸ”’ Ciphers seguros (ECDHE)
- ðŸ”’ HSTS habilitado
- ðŸ”’ Headers de seguranÃ§a (X-Frame-Options, X-Content-Type-Options, etc.)
- ðŸ”’ SSL Stapling habilitado

## PersonalizaÃ§Ã£o

### Adicionando novos subdomÃ­nios
1. Adicione o subdomÃ­nio em `domain_subdomains` no `group_vars/all.yml`
2. Execute o playbook novamente
3. O certificado serÃ¡ atualizado automaticamente

### Modificando configuraÃ§Ãµes SSL
Edite as variÃ¡veis no `group_vars/all.yml`:
```yaml
nginx_ssl_protocols: "TLSv1.2 TLSv1.3"
nginx_ssl_ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:..."
```

### Testando com certificados staging
Para evitar rate limits durante testes:
```yaml
ssl_certificate_staging: true
```

## Troubleshooting

### ForÃ§ar renovaÃ§Ã£o de certificado
```yaml
ssl_certificate_force_renewal: true
```

### Verificar logs do Certbot
```bash
sudo journalctl -u certbot
# ou
sudo tail -f /var/log/letsencrypt/letsencrypt.log
```

### Verificar configuraÃ§Ã£o do Nginx
```bash
sudo nginx -t
```